// prisma/schema.prisma
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/**
 * ======================= ENUMS =======================
 */

enum CustomerOrigin {
  PHONE
  WALKIN
  UBER
  GLOVO
  QR
}
enum CustomerSegment {
  S1 // Potencial: 0‚Äì1 compras
  S2 // Inactivo: >1 compras y √∫ltima > 30 d√≠as
  S3 // Activo:   √∫ltima ‚â§ 30 d√≠as
  S4 // CMV:      S3 y ticket medio > ticket medio empresa
}
enum DeliveryMethod {
  PICKUP
  COURIER
  UBER
  GLOVO
}
enum OrderStatus {
  PENDING
  AWAITING_PAYMENT
  PAID
  CANCELED
}
enum Channel {
  WHATSAPP
  PHONE
  WEB
}
enum CouponKind {
  PERCENT
  AMOUNT
}
enum CouponVariant {
  FIXED
  RANGE
}
enum CouponStatus {
  ACTIVE
  USED
  EXPIRED
  DISABLED
}
enum CouponAcquisition {
  GAME // premio de juego
  CLAIM // reclamo manual / galer√≠a
  REWARD // recompensa (p.ej. after-purchase)
  BULK // carga masiva u operaci√≥n
  DIRECT // entregado ad-hoc
  OTHER
}
enum CouponLogic {
  RANDOM
  PERCENT
  AMOUNT
}
enum CouponChannel {
  GAME
  WEB
  CRM
  STORE
  APP
  SMS
  EMAIL
}
enum WhatsAppDirection {
  IN
  OUT
}
enum WhatsAppMessageStatus {
  RECEIVED
  SENT
  DELIVERED
  READ
  FAILED
}
enum IngredientStatus {
  ACTIVE
  INACTIVE
}
enum ProductStatus {
  ACTIVE
  INACTIVE
}
enum CouponVisibility {
  PUBLIC
  RESERVED
}
enum POSJobStatus {
  PENDING
  PROCESSING
  PRINTED
  FAILED
}


/**
 * ======================= MODELOS =======================
 */

model MenuPizza {
  id            Int                   @id @default(autoincrement())
  name          String
  category      String?
  selectSize    Json
  priceBySize   Json
  cookingMethod String?
  image         String?        // secure_url
  imagePublicId String?        // üëà CLAVE para Cloudinary
  status        ProductStatus         @default(ACTIVE)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  ingredients   MenuPizzaIngredient[]
  stocks        StorePizzaStock[]
}
model MenuPizzaIngredient {
  id           Int  @id @default(autoincrement())
  menuPizzaId  Int
  ingredientId Int
  qtyBySize    Json

  menuPizza  MenuPizza  @relation(fields: [menuPizzaId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@index([ingredientId])
  @@index([menuPizzaId])
}
model Ingredient {
  id         Int                   @id @default(autoincrement())
  name       String
  category   String
  stock      Int                   @default(0)
  unit       String?
  costPrice  Float?
  menuPizzas MenuPizzaIngredient[]
  status     IngredientStatus      @default(ACTIVE)
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  ingredientExtras IngredientExtra[]
  storeStocks StoreIngredientStock[]
}
model Store {
  id              Int                @id @default(autoincrement())
  storeName       String
  address         String
  latitude        Float?
  longitude       Float?
  city            String?
  zipCode         String?
  email           String?
  tlf             String?
  active          Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  acceptingOrders Boolean            @default(true)
  stocks          StorePizzaStock[]
  ingredientStocks StoreIngredientStock[]
  sales           Sale[]
  redemptions     CouponRedemption[] @relation("StoreToRedemptions")
  games           Game[]
}
model StorePizzaStock {
  storeId   Int
  pizzaId   Int
  stock     Int       @default(0)
  active    Boolean   @default(true) 
  updatedAt DateTime  @updatedAt
  createdAt DateTime  @default(now())
  store     Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  pizza     MenuPizza @relation(fields: [pizzaId], references: [id], onDelete: Cascade)

  @@id([storeId, pizzaId])
}
model Customer {
  id                Int             @id @default(autoincrement())
  code              String          @unique
  name              String?
  phone             String?         @unique
  email             String?         @unique
  address_1         String
  portal            String?
  observations      String?
  lat               Float?
  lng               Float?
  origin            CustomerOrigin  @default(PHONE)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  daysOff           Int?
  isRestricted      Boolean         @default(false)
  restrictedAt      DateTime?
  restrictionReason String?
  segment           CustomerSegment @default(S1)
  segmentUpdatedAt  DateTime?

  assignedCoupons Coupon[]           @relation("CustomerAssignedCoupons")
  sales           Sale[]             @relation("CustomerSales")
  redemptions     CouponRedemption[] @relation("CustomerToRedemptions")
  plays           GamePlay[]
}
model Sale {
  id                      Int            @id @default(autoincrement())
  code                    String         @unique
  date                    DateTime       @default(now())
  deliveredAt             DateTime?
  storeId                 Int
  customerId              Int?
  type                    String
  delivery                DeliveryMethod
  customerData            Json?
  products                Json
  extras                  Json           @default("[]")
  totalProducts           Float
  discounts               Float          @default(0)
  total                   Float
  processed               Boolean        @default(false)
  notes                   String?
  createdAt               DateTime       @default(now())
  status                  OrderStatus    @default(PENDING)
  channel                 Channel        @default(WHATSAPP)
  currency                String         @default("EUR")
  address_1               String?
  lat                     Float?
  lng                     Float?
  stripePaymentIntentId   String?        @unique @db.VarChar(191)
  stripeCheckoutSessionId String?        @unique @db.VarChar(191)

  store    Store     @relation(fields: [storeId], references: [id])
  customer Customer? @relation("CustomerSales", fields: [customerId], references: [id])

  redemptions CouponRedemption[] @relation("SaleToRedemptions")

  @@index([date])
}
model AppMeta {
  id              Int      @id @default(1)
  acceptingOrders Boolean  @default(true)
  closedMessage   String?  @db.Text
  updatedAt       DateTime @updatedAt
}
model Coupon {
  id           Int                @id @default(autoincrement())
  code         String             @unique
  kind         CouponKind         @default(PERCENT)
  variant      CouponVariant      @default(FIXED)
  percent      Int?
  amount       Decimal?           @db.Decimal(10, 2)
  percentMin   Int?
  percentMax   Int?
  maxAmount    Decimal?           @db.Decimal(10, 2)
  acquisition  CouponAcquisition?
  channel      CouponChannel?
  gameId       Int?
  campaign     String?
  meta         Json?
  segments     Json?
  assignedTold Int?
  visibility    CouponVisibility  @default(PUBLIC)
  assignedTo   Customer?          @relation("CustomerAssignedCoupons", fields: [assignedTold], references: [id], onDelete: SetNull)
  activeFrom   DateTime?
  expiresAt    DateTime?
  daysActive   Json?
  windowStart  Int?
  windowEnd    Int?
  usageLimit   Int                @default(1)
  usedCount    Int                @default(0)
  status       CouponStatus       @default(ACTIVE)
  usedAt       DateTime?
  createdAt    DateTime           @default(now())
  game         Game?              @relation("GameCoupons", fields: [gameId], references: [id], onDelete: SetNull)
  redemptions  CouponRedemption[] @relation("CouponToRedemptions")
  
  @@index([status])
  @@index([assignedTold])
  @@index([expiresAt])
  // √çndices √∫tiles para pools y anal√≠tica
  @@index([acquisition])
  @@index([channel])
  @@index([gameId])
  @@index([acquisition, gameId])
}
model CouponRedemption {
  id Int @id @default(autoincrement())

  couponId Int?
  coupon   Coupon? @relation("CouponToRedemptions", fields: [couponId], references: [id], onDelete: SetNull)

  saleId Int?
  sale   Sale? @relation("SaleToRedemptions", fields: [saleId], references: [id], onDelete: SetNull)

  customerId Int?
  customer   Customer? @relation("CustomerToRedemptions", fields: [customerId], references: [id], onDelete: SetNull)

  storeId Int?
  store   Store? @relation("StoreToRedemptions", fields: [storeId], references: [id], onDelete: SetNull)

  couponCode String

  // Snapshot de contexto (NUEVO - opcional)
  acquisition CouponAcquisition?
  channel     CouponChannel?
  gameId      Int?
  campaign    String?

  segmentAtRedeem CustomerSegment?
  kind            CouponKind
  variant         CouponVariant
  percentApplied  Int?
  amountApplied   Decimal?         @db.Decimal(10, 2)

  discountValue Decimal? @db.Decimal(10, 2)

  redeemedAt DateTime @default(now())
  createdAt  DateTime @default(now())

  @@index([couponCode])
  @@index([redeemedAt])
  @@index([saleId])
  @@index([customerId])
  @@index([storeId])
  @@index([gameId])
  @@index([channel])
  @@index([acquisition])
}
model Game {
  id          Int        @id @default(autoincrement())
  name        String
  slug        String     @unique
  description String?
  image       String?
  active      Boolean    @default(true)
  storeId     Int?
  store       Store?     @relation(fields: [storeId], references: [id], onDelete: SetNull)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  coupons     Coupon[]   @relation("GameCoupons")
  plays       GamePlay[]
}
model GamePlay {
  id        Int       @id @default(autoincrement())
  gameId    Int
  playerId  Int?
  ip        String?
  result    Json?
  won       Boolean   @default(false)
  createdAt DateTime  @default(now())
  game      Game      @relation(fields: [gameId], references: [id])
  customer  Customer? @relation(fields: [playerId], references: [id])

  @@index([gameId, createdAt])
  @@index([playerId, createdAt])
}
model WhatsAppConversation {
  id               Int               @id @default(autoincrement())
  phoneE164        String            @unique @db.VarChar(32)
  phoneBase9       String?           @db.VarChar(16)
  username         String?           @db.VarChar(191)
  addressText      String?           @db.Text
  addressUpdatedAt DateTime?
  lastMessageAt    DateTime?
  isOpen           Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  messages         WhatsAppMessage[]

  @@index([lastMessageAt])
  @@index([phoneBase9])
}
model WhatsAppMessage {
  id             Int                   @id @default(autoincrement())
  conversationId Int
  waMessageId    String?               @unique @db.VarChar(191)
  direction      WhatsAppDirection
  status         WhatsAppMessageStatus @default(RECEIVED)
  from           String                @db.VarChar(32)
  to             String?               @db.VarChar(32)
  type           String?               @db.VarChar(32)
  text           String?               @db.Text
  timestamp      DateTime?
  createdAt      DateTime              @default(now())
  conversation   WhatsAppConversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([from])
}
model Category {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  position  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ingredientExtras IngredientExtra[]
}
model IngredientExtra {
  id           Int      @id @default(autoincrement())
  ingredientId Int
  categoryId   Int
  price        Float    @default(0)
  status       String   @default("ACTIVE")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ingredient Ingredient @relation(fields: [ingredientId], references: [id])
  category   Category   @relation(fields: [categoryId], references: [id])

  @@unique([ingredientId, categoryId])
}
model StoreIngredientStock {
  storeId      Int
  ingredientId Int
  stock        Int      @default(0)
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  store       Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  ingredient  Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  @@id([storeId, ingredientId])
}
model POS {
  id          Int      @id @default(autoincrement())
  storeId     Int
  code        String   @unique        // ej: "POS_OURENSE_1"
  name        String?
  isActive    Boolean  @default(true)

  lastSeenAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  jobs        POSJob[]
}
model POSJob {
  id          Int      @id @default(autoincrement())

  posId       Int
  pos         POS      @relation(fields: [posId], references: [id])
  type        String   
  payload     Json    
  status      String   @default("PENDING")
  // PENDING | PROCESSING | PRINTED | FAILED

  attempts    Int      @default(0)
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  processedAt DateTime?

  @@index([posId, status])
}
